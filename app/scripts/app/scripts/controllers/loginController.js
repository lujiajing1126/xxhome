define(function(a,b,c){function d(){var a="",b=j("#USERNAME").val(),c=j("#PASSWORD").val();return r.test(b)||q.test(b)?""==c&&(a="密码不能为空！"):a="账号格式为邮箱或手机号！",""!=a?(g(a),!1):!0}function e(){var a=j("#PHONENUM").val(),b=j("#AUTHCODE").val(),c=j("#P_PWD").val(),d=j("#P_REPWD").val(),e=/(^0{0,1}1[3|4|5|6|7|8|9][0-9]{9}$)/,f=/[0-9]{6}/,g="";return e.test(a)?f.test(b)?""==c?g="密码不能为空！":d!=c?g="两次密码不同！":(c.length<3||c.length>12)&&(g="密码长度为3-12位"):g="验证码格式为6位数字":g="手机号码格式不对！",""!=g?(i(g),!1):!0}function f(){var a=j("#EMAIL").val(),b=j("#E_PWD").val(),c=j("#E_REPWD").val(),d=/^\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$/,e="";return d.test(a)?""==b?e="密码不能为空！":c!=b?e="两次密码不同！":(b.length<3||b.length>12)&&(e="密码长度为3-12位"):e="邮箱格式不对！",""!=e?(h(e),!1):!0}function g(a){var b=j("#Login_Box_Wrapper").find(".tip");b.addClass("on").children("span").text(a),setTimeout(function(){b.removeClass("on").children("span").text("")},s)}function h(a){var b=j("#Signup_Box_Wrapper").find("#Signup_Tip2");b.addClass("on").children("span").text(a),setTimeout(function(){b.removeClass("on").children("span").text("")},s)}function i(a){var b=j("#Signup_Box_Wrapper").find("#Signup_Tip");b.addClass("on").children("span").text(a),setTimeout(function(){b.removeClass("on").children("span").text("")},s)}var j=SUI.$,k=a("scripts/baseController"),l=new k,m=a("scripts/models/oUserModel"),n=a("build/template"),o=a("scripts/public/helper"),p=a("scripts/services/OrgService"),q=/(^0{0,1}1[3|4|5|6|7|8|9][0-9]{9}$)/,r=/^\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$/,s=3e3,t=function(){var a=this;this.namespace="login",this.actions={loginBox:function(){var b=j("#Login_Box_Wrapper");b.length>0?b.addClass("on"):j("body").append(n("app/templates/partial/login",{})),j("#USERNAME").trigger("focus"),j(document).on("keydown."+a.namespace,function(b){b=b||window.event,27==b.keyCode&&a.actions.closeLoginBox(),13==b.keyCode&&j("#BOX_BTN_SIGNIN").trigger("click")})},signupBox:function(){j(".login-box.on").removeClass("on");var b=j("#Signup_Box_Wrapper");b.length>0?b.addClass("on"):(j("body").append(n("app/templates/partial/signup",{})),j(document).on("keyup."+a.namespace,"#PHONENUM",function(){v(this)})),j("#PHONENUM:visible,#EMAIL:visible").trigger("focus"),j(document).on("keydown."+a.namespace,function(b){b=b||window.event,27==b.keyCode&&a.actions.closeSignupBox()})},closeLoginBox:function(){u("Login_Box_Wrapper")},closeSignupBox:function(){u("Signup_Box_Wrapper")},login:function(a){var b=this,c=j("#PASSWORD").val(),e=j("#USERNAME").val();if(a=a||window.event,a.preventDefault(),d()){if(r.test(e))var f={email:e};else var f={phone_number:e};j(b).attr("disabled","disabled").val("正在登陆...");var h=AppUser.getSession();h?AppUser.login(j.extend({session:h,password:c},f)).then(function(){j("#Login_Box_Wrapper").removeClass("on")})["catch"](function(a){g(a)}).done(function(){j(b).removeAttr("disabled").val("登陆")}):window.location.reload()}},changeModule:function(){var a=this.className;j(this).parents("#Signup_Box").attr({"class":"box "+a})},getAuthCode:function(){var a=j(this),b=j("input#PHONENUM").val();if(q.test(j.trim(b))){if(!a.hasClass("disabled")){a.addClass("disabled");var c=60,d=function(){return a.text(c--+"秒之后重试"),0==c?void a.removeClass("disabled").text("重新发送"):void setTimeout(function(){d()},1e3)};d()}var e=AppUser.getSession();return o.globalResponseHandler({url:"/api/account/send_verification_request_to_phone_number",type:"POST",dataType:"JSON",data:{phone_number:b,session:e}}).then(function(a){"OK"==a.status&&alert("验证码已经在路上了！")})["catch"](function(a){i(a)}).done(),!1}return i("手机号码不能为空!"),!1},signup_phone:function(b){var c=this,b=b||window.event;if(b.preventDefault(),e()){j(c).attr("disabled","disabled").val("注册中...");var d=j("input#PHONENUM").val(),f=j("#AUTHCODE").val(),g=j("#P_PWD").val(),h=AppUser.getSession();h?o.globalResponseHandler({url:"/api/account/register",type:"post",dataType:"json",data:{session:h,phone_number:d,phone_number_verification_code:f,password:g}}).then(function(b){if("OK"!=b.status)throw"注册失败";a.actions.closeSignupBox(),alert("注册成功")})["catch"](function(a){i(a)}).done(function(){j(c).removeAttr("disabled").val("注册")}):(i("session不存在"),window.location.reload())}},signup_email:function(b){var c=this,b=b||window.event;if(b.preventDefault(),f()){j(c).attr("disabled","disabled").val("注册中...");var d=j("#EMAIL").val(),e=j("#E_PWD").val(),g=AppUser.getSession();g?o.globalResponseHandler({url:"/api/account/register",type:"post",dataType:"json",data:{session:g,email:d,password:e}}).then(function(b){if("OK"!=b.status)throw"注册失败";alert("请求成功，请查收您的邮箱并验证！"),a.actions.closeSignupBox()})["catch"](function(a){h(a)}).done(function(){j(c).removeAttr("disabled").val("注册并验证邮箱")}):(i("session不存在"),window.location.reload())}return!1},Logout:function(){AppUser.logout()},createOrganization:function(){var a=AppUser.getSession();if(!a)return void alert("请先登录！");var b=prompt("请输入组织名称");b&&p.createOrganization(b,a).then(function(a){"OK"==a.status&&(alert("组织创建成功，您可以进入组织管理系统！"),window.location.reload())})["catch"](function(a){alert(a)}).done()}}};l.extend(t),t.prototype.init=function(a){var b=this;window.AppUser=new m,AppUser.init(a),j(document).on("click","[data-xx-login-action]",function(a){var c=j(this).attr("data-xx-login-action");b.actions[c]&&j.isFunction(b.actions[c])&&b.actions[c].call(this,a)})};var u=function(a){j("#"+a).removeClass("on"),j(document).off(".login")},v=function(a){var b=j(a).val();q.test(j.trim(b))?j("#authButton").addClass("on"):j("#authButton").removeClass("on")};c.exports=t});