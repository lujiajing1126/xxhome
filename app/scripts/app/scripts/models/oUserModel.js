define(function(a,b,c){function d(a){var b;e.ajax({url:"/api/account/list_administrated_organizations?session="+a,dataType:"json",success:function(a){if("OK"!=a.status)throw a;b=a.organizations&&a.organizations.length>0?"<a href='/home.html#index' target='_blank'><span>组织管理</span></a> <i></i><a href='javascript:void(0);' data-xx-login-action='Logout'>退出</a>":"<a href='javascript:void(0);' data-xx-login-action='createOrganization'><span class='org-add'>+创建组织</span></a> <i></i><a href='javascript:void(0);' data-xx-login-action='Logout'>退出</a>",e("#userBox").html(b)},error:function(){alert("组织信息获取失败！")}})}var e=SUI.$,f=a("sui/async/q"),g=a("scripts/services/oUserService"),h=a("scripts/public/helper");a("sui/core/cookie"),User=function(){var a=null;return function(){this.id="",this.name="",this.org="",this.orgs=[],this.setSession=function(b){a=b,e.cookie("userSession",b,{path:"/"})},this.clearSession=function(){a=null,e.removeCookie("userSession",{path:"/"})},this.getSession=function(){return a}}}(),User.prototype.init=function(a){var b=this,c=e.cookie("userSession");c?b.isUserLogin(c,a):h.getSession().then(function(c){b.isUserLogin(c,a)})["catch"](function(a){alert(a)}).done()},User.prototype.auth=function(a){var b=this.getSession();b||(window.location.href="/index.html"),this.getLoginStatus(b,a)},User.prototype.login=function(a){var b=a.session,c=this,g=h.getParam("dev"),i=g?"/api/account/login":"https://xiaoxiao.la/api/account/login";return f(e.ajax({url:i,type:"POST",dataType:"JSON",data:a,crossDomain:!1})).then(function(a){if("OK"==a.status)return d(b),c.id=a.userId,b;throw"Error"==a.status?a.message:a.status},function(){throw"╮(╯▽╰)╭服务器君挂了，请稍后再试!"})},User.prototype.getLoginStatus=function(a,b){var c=this;h.globalResponseHandler({url:"/api/account/id?session="+a,dataType:"JSON"}).then(function(b){return b&&b.userId?(c.id=b.userId,a):void e.goHome("登陆失效！")}).then(function(a){c.getUserInfo(a,b)})},User.prototype.isUserLogin=function(a,b){if(a){var c=this;c.isLogin=!1,c.setSession(a),h.globalResponseHandler({url:"/api/account/id?session="+a,dataType:"JSON"}).then(function(b){b&&b.userId?(c.id=b.userId,c.setSession(a),c.isLogin=!0,d(a)):"Not Logged In"==b||(c.clearSession(),window.location.reload())}).done(function(){b&&e.isFunction(b)&&b(a)})}},User.prototype.getUserInfo=function(a,b){var c=this,d=c.id;g.getOwnerUserInfo(d,a).then(function(a){e.each(["userInfo","studentInfo","extendedUserInfo"],function(b,d){c[d]={},a[d]&&e.each(a[d],function(a,b){c[d][a]=b})})},function(){}).then(function(){return e.ajax({url:"/api/account/list_administrated_organizations?session="+a,type:"GET",dataType:"JSON"})}).then(function(a){c.orgs=[],c.org=null,a.organizations&&0!=a.organizations.length?c.orgs=a.organizations:e.goHome("您暂无可管理的组织，请在首页新建组织");var b=e.cookie("currentOrganization");e.each(a.organizations,function(a,d){b&&d.id==b&&(c.org=d)}),c.org||(c.org=a.org||c.orgs[0])},function(a){seajs.log(a)}).done(function(){b&&e.isFunction(b)&&b()})},User.prototype.switchOrganization=function(a){var b=this,c=b.orgs,d=!1;e.each(c,function(b,c){return c.id==a?(d=!0,e.cookie("currentOrganization",a,{path:"/"}),void window.location.reload()):void 0}),d||alert("组织不存在！")},User.prototype.logout=function(){var a=this;h.globalResponseHandler({url:"/api/account/logout",type:"POST",data:{session:this.getSession()},dataType:"JSON"}).then(function(){},function(){}).done(function(){a.clearSession(),window.location.reload()})},User.prototype._login=function(a){this.id=a.id,this.name=a.name,this.org=a.org},c.exports=User});